$.tools.validator.addEffect("depageEffect",function(a){$.each(a,function(a,c){var d=$(c.input).parents("p");$errorMessage=d.find(".errorMessage");$errorMessage.length===0?(d.append('<span class="errorMessage">'+d.attr("data-errorMessage")+"</span>"),d.addClass("error")):$errorMessage.show()})},function(a){$.each(a,function(a,c){var d=$(c).parents("p");d.removeClass("error");d.find(".errorMessage").remove()})});
$(document).ready(function(){$(".depage-form").each(function(){var a=this,b=$(this),c=b.attr("data-jsvalidation"),d=b.attr("data-jsautosave");c=="blur"||c=="change"?b.validator({effect:"depageEffect",inputEvent:c,errorInputEvent:c}):c=="submit"&&b.validator({effect:"depageEffect",errorInputEvent:null});b.bind("onFail",function(){b.find(".submit").addClass("error")});b.bind("onSuccess",function(){b.find(".errorMessage").length>0?b.find(".submit").addClass("error"):b.find(".submit").removeClass("error")});
b.delegate(".error input","focus",function(){$(this).parents(".error").find(".errorMessage").hide()});if(d=="true"){var e=new Date;a.data=a.data||{};a.data.saving=false;a.data.lastsave=e.getTime();a.data.timer=null;a.data.autosave=function(){var b={};$("input, select",a).each(function(){console.log("input: "+this.name+" = "+this.value);b[this.name]=this.value});b["form-autosave"]="true";a.data.saving=true;$.post(a.action,b,function(){e=new Date;a.data.lastsave=e.getTime();a.data.saving=false;console.log("saved")})};
a.data.changed=function(b){e=new Date;clearTimeout(a.data.timer);a.data.saving||(b||e.getTime()-a.data.lastsave>1E3?a.data.autosave():setTimeout(function(){a.data.changed()},1E3))};$("input, select",a).change(function(){a.data.changed(true)})}$(".input-richtext",a).each(function(){var a=$(this).data("richtext-options");$("textarea",this).depageEditor(a)});$("input[autofocus]:first",a).focus()})});
