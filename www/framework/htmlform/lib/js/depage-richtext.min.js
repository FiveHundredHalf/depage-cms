(function(a){a.removeDuplicate=function(a){if(a instanceof Array){label:for(var b=0;b<a.length;b++)for(var c=0;c<a.length;c++){if(c==b)continue;if(a[c]==a[b]){a=a.slice(c);continue label}}return a}},a.extend(a.expr[":"],{inline:function(b){return a(b).is("a")||a(b).is("em")||a(b).is("i")||a(b).is("font")||a(b).is("span")||a(b).is("strong")||a(b).is("b")||a(b).is("u")}});var b=function(b,d){a.extend(this,{settings:d,createDOM:function(){this.textarea=b,this.container=document.createElement("div"),this.iframe=document.createElement("iframe"),this.input=document.createElement("input"),this.stylesheetLink=document.createElement("a"),this.settings.stylesheet=a(this.stylesheetLink).attr({href:this.settings.stylesheet})[0].href+"?"+Math.random(),a(this.input).attr({type:"hidden",name:a(this.textarea).attr("name"),value:a(this.textarea).attr("value")}),a(this.textarea).addClass("depageEditorTextarea"),a(this.textarea).attr("name",a(this.textarea).attr("name")+"depageEditorTextarea"),a(this.textarea).hide(),a(this.container).addClass(d.containerClass),a(this.iframe).addClass("depageEditorIframe"),this.toolbar=new c(this),a(this.container).append(this.toolbar.itemsList),a(this.container).append(this.iframe),a(this.container).append(this.input),a(this.container).hide(),this.input.depageEditorObject=this,a(this.textarea).replaceWith(this.container)},writeDocument:function(){var b='\n                    <html>\n                        <head>\n                            INSERT:STYLESHEET:END\n                        </head>\n                        <body id="iframeBody">\n                            INSERT:CONTENT:END\n                        </body>\n                    </html>\n                ';b=a.browser.msie?b.replace(/INSERT:STYLESHEET:END/,'<link rel="stylesheet" type="text/css" href="'+this.depageEditorStylesheet+'"></link>'):b.replace(/INSERT:STYLESHEET:END/,""),b=b.replace(/INSERT:CONTENT:END/,a(this.input).val()),this.iframe.contentWindow.document.open(),this.iframe.contentWindow.document.write(b),this.iframe.contentWindow.document.close(),a.browser.msie||a(this.iframe.contentWindow.document).find("head").append(a(this.iframe.contentWindow.document.createElement("link")).attr({rel:"stylesheet",type:"text/css",href:d.stylesheet}));var c=this;a(this.iframe).load(function(){c.autogrow()})},makeEditable:function(){var b=this;try{this.iframe.contentWindow.document.designMode="on"}catch(c){setTimeout(function(){b.makeEditable()},250);return!1}a(this.container).show(),a(this.textarea).show(),a(this.iframe.contentWindow.document).mouseup(function(){b.toolbar.checkState(b),b.autogrow()}),a(this.iframe.contentWindow.document).keyup(function(){b.toolbar.checkState(b),b.autogrow()}),a(this.iframe.contentWindow.document).keydown(function(a){b.detectPaste(a),b.autogrow()}),a(this.iframe.contentWindow.document).scroll(function(){b.autogrow()}),this.locked=!1},focusEditor:function(){a.browser.msie||this.iframe.focus()},styleWithCSS:function(){try{this.iframe.contentWindow.document.execCommand("styleWithCSS",!1,!1)}catch(a){try{this.iframe.contentWindow.document.execCommand("useCSS",0,!0)}catch(a){}}},modifyFormSubmit:function(){var b=this,c=a(this.container).parents("form");c.submit(function(){return b.updateDepageEditorInput()})},insertNewParagraph:function(b,c){var d=a(this.iframe).contents().find("body"),e=this.iframe.contentWindow.document.createElement("p");a(b).each(function(){a(e).append(this)}),d.append(e)},paragraphise:function(){if(d.insertParagraphs&&this.wysiwyg){var b=a(this.iframe).contents().find("body").contents();b.each(function(){this.nodeName.toLowerCase()=="#text"&&this.data.search(/^\s*$/)!=-1&&(this.data="")});var c=this,e=[];b.each(function(){if(a(this).is(":inline")||this.nodeType==3)e.push(this),a(this).remove();else if(a(this).is("br")){if(!a(this).is(":last-child"))if(a(this).next().is("br")){while(a(this).next().is("br"))a(this).remove();e.length&&(c.insertNewParagraph(e,this),e=[])}else!a(this).is(":inline")&&this.nodeType!=3?a(this).remove():e.length?(e.push(this.cloneNode(!0)),a(this).remove()):a(this).remove()}else e.length&&(c.insertNewParagraph(e,this),e=[])}),e.length>0&&this.insertNewParagraph(e)}},switchMode:function(){this.locked||(this.locked=!0,this.wysiwyg?(this.updateDepageEditorInput(),a(this.textarea).val(a(this.input).val()),a(this.iframe).replaceWith(this.textarea),this.toolbar.disable(),this.wysiwyg=!1,this.locked=!1):(this.updateDepageEditorInput(),a(this.textarea).replaceWith(this.iframe),this.writeDocument(this.input.value),this.toolbar.enable(),this.makeEditable(),this.wysiwyg=!0))},detectPaste:function(b){if(b.ctrlKey&&b.keyCode==86&&!this.cleaning){var c=this;setTimeout(function(a){c.cleanSource()},100)}if(b.keyCode==13){var d=this.getSelection(),e=d.parentnode;while(e[0].nodeType==3||e.is(":inline"))e=e.parent();var f=e[0].nodeName.toLowerCase();if(f=="body"||f=="div"){var g=a.browser.msie?"<p>":"p";this.styleWithCSS(),this.iframe.contentWindow.document.execCommand("FormatBlock",!1,g)}}},cleanSource:function(){this.cleaning=!0;var b="",c=a(this.iframe.contentWindow.document).find("body");c.find("*").each(function(){var b=this.nodeName.toLowerCase();if(a.inArray(b,d.allowedTags)===-1){var c=d.undesiredTags[b];if(c=="remove")a(this).remove();else{var e=a(this),f=e.parent()[0].tagName.toLowerCase();if(f=="body"&&this.firstChild&&(a(this.firstChild).is(":inline")||this.firstChild.nodeType==3)){var g=a("<p></p>").insertBefore(e);e.contents().each(function(){g.append(this)})}else e.contents().each(function(){e.before(this)});e.remove()}}}),this.wysiwyg?b=c.html():b=a(this.textarea).val(),b=b.replace(/^\s*/,""),b=b.replace(/\s*$/,""),b=b.replace(/<--.*-->/,""),b=b.replace(/<[^>]*>/g,function(b){b=b.replace(/='(.*)' /g,'="$1" '),b=b.replace(/ ([^=]+)="?([^"]*)"?/g,function(b,c,e){if(a.inArray(c,d.allowedAttributes)==-1)return"";switch(c){case"id":if(a.inArray(e,d.allowedIDs)==-1)return"";case"class":if(a.inArray(e,d.allowedClasses)==-1)return"";default:return b}});return b.toLowerCase()}),b=b.replace(/ style="[^"]*"/g,""),b=b.replace(/<br>/g,"<br />"),b=b.replace(/<br \/>\s*<\/(h1|h2|h3|h4|h5|h6|li|p)/g,"</$1"),b=b.replace(/(<br \/>)*\s*(<\/[^>]*>)/g,"$2$1"),b=b.replace(/(<img [^>]+[^\/])>/g,"$1 />"),b=b.replace(/(<[^\/]>|<[^\/][^>]*[^\/]>)\s*<\/[^>]*>/g,""),b=b.replace(/<\?xml[^>]*>/g,""),b=b.replace(/<[^ >]+:[^>]*>/g,""),b=b.replace(/<\/[^ >]+:[^>]*>/g,""),this.wysiwyg?a(this.iframe.contentWindow.document).find("body").html(b):a(this.textarea).val(b),a(this.input).val(b),this.cleaning=!1},refreshDisplay:function(){this.wysiwyg?a(this.iframe.contentWindow.document).find("body").html(a(this.input).val()):a(this.textarea).val(a(this.input).val())},autogrow:function(){if(this.settings.autogrow!=!1&&this.wysiwyg){var b=60,c=a(this.iframe.contentWindow.document.body),d=a(this.toolbar.itemsList),e=0;if(c[0]==undefined)return;var f=c.children(":last");f.length>0?e=f.position().top+f.height()+b:e=a(c).height()+b,e=Math.max(e,d.height()),c.css({overflow:"hidden",scroll:"no"}),a(this.iframe).height(e),a(this.textarea).height(e);var g=Math.max(0,a(window).scrollTop()-a(this.iframe).offset().top);g=Math.min(g,a(this.iframe).height()-d.height()),d.css({top:g})}},updateDepageEditorInput:function(){this.wysiwyg?(this.paragraphise(),this.cleanSource()):a(this.input).val(a(this.textarea).val())},getSelection:function(){var b=null,c=null,d=null;if(this.iframe.contentWindow.document.selection){b=this.iframe.contentWindow.document.selection,c=b.createRange();try{d=a(c.parentElement())}catch(e){return!1}}else{try{b=this.iframe.contentWindow.getSelection()}catch(e){return!1}c=b.getRangeAt(0),d=a(c.commonAncestorContainer)}return{range:c,parentnode:d}},init:function(b){var c=this;if(typeof document.designMode=="string"||document.designMode=="off")this.locked=!0,this.cleaning=!1,this.DOMCache="",this.wysiwyg=!0,this.createDOM(),this.writeDocument(),this.makeEditable(),this.modifyFormSubmit(),this.autogrow(),a(window).scroll(function(){c.autogrow()})}}),this.init()},c=function(b){a.extend(this,{createDOM:function(){var b=this;this.itemsList=document.createElement("ul"),a(this.itemsList).addClass("depageEditorToolbar"),a.each(this.depageEditor.settings.toolbarItems,function(a,c){c=="formatblock"?b.addSelect(c):b.addButton(c)})},addButton:function(b){var c=a.depageEditorToolbarItems[b],d=a(document.createElement("li")),e=typeof this.depageEditor.settings.translation[b]!="undefined"?this.depageEditor.settings.translation[b]:c.label,f=a(document.createElement("a")).attr({title:e,"class":c.className,href:"#"+e}).click(function(){return!1});c.editor=this.depageEditor,a(f).data("action",c),a(f).data("editor",this.depageEditor),f.bind("click",c.action),f.append(document.createTextNode(e)),d.append(f),a(this.itemsList).append(d)},addSelect:function(b){var c=this,d=a.depageEditorToolbarItems[b],e=a(document.createElement("li")).attr("class","depageEditorEditSelect"),f=a(document.createElement("select")).attr({name:d.name,"class":d.className});a(f).data("editor",this.depageEditor),a(f).change(d.action);var g=a(document.createElement("option")),h=typeof this.depageEditor.settings.translation[b]!="undefined"?this.depageEditor.settings.translation[b]:d.label;g.append(document.createTextNode(h)),f.append(g),a.each(this.depageEditor.settings.selectBlockOptions,function(b,d){var e=a(document.createElement("option")).attr("value",d);e.append(document.createTextNode(c.depageEditor.settings.translation[d])),f.append(e)}),e.append(f),a(this.itemsList).append(e)},disable:function(){a(this.itemsList).toggleClass("depageEditorSource"),a(this.itemsList).find("li select").attr("disabled","disabled")},enable:function(){a(this.itemsList).toggleClass("depageEditorSource"),a(this.itemsList).find("select").removeAttr("disabled")},checkState:function(b,c){if(!c){setTimeout(function(){b.toolbar.checkState(b,!0);return!0},200);return!0}a(b.toolbar.itemsList).find("a").removeClass("on");var d=b.getSelection(),e=d.range,f=d.parentnode;while(f[0].nodeType==3)f=f.parent();while(!f.is("body"))f.is("a")?b.toolbar.setState("link","on"):f.is("em")||f.is("i")?b.toolbar.setState("italic","on"):f.is("strong")||f.is("b")?b.toolbar.setState("bold","on"):f.is("span")||f.is("p")?(f.css("font-style")=="italic"&&b.toolbar.setState("italic","on"),f.css("font-weight")=="bold"&&b.toolbar.setState("bold","on")):f.is("ol")?(b.toolbar.setState("orderedlist","on"),b.toolbar.setState("unorderedlist","off")):f.is("ul")?(b.toolbar.setState("orderedlist","on"),b.toolbar.setState("unorderedlist","off")):b.toolbar.setState("formatblock",f[0].nodeName.toLowerCase()),f=f.parent()},setState:function(b,c){b!="SelectBlock"?a(this.itemsList).find("."+a.depageEditorToolbarItems[b].className).addClass("on"):a(this.itemsList).find("."+a.depageEditorToolbarItems[b].className).val(c)},init:function(a){this.depageEditor=a,this.createDOM()}}),this.init(b)},d=function(){depageEditorToolbarItemsClass=this.constructor;if(typeof depageEditorToolbarItemsClass.singleton!="undefined")return depageEditorToolbarItemsClass.singleton;depageEditorToolbarItemsClass.singleton=this,a.extend(depageEditorToolbarItemsClass.singleton,{bold:{className:"depageEditorButtonBold",action:function(){var b=a.data(this,"editor");!b.wysiwyg||(b.styleWithCSS(),b.iframe.contentWindow.document.execCommand("bold",!1,null),b.toolbar.setState("bold","on"),b.focusEditor())}},italic:{className:"depageEditorButtonItalic",action:function(){var b=a.data(this,"editor");!b.wysiwyg||(b.styleWithCSS(),b.iframe.contentWindow.document.execCommand("italic",!1,null),b.toolbar.setState("italic","on"),b.focusEditor())}},link:{className:"depageEditorButtonHyperlink",action:function(){var b=a.data(this,"editor");if(!!b.wysiwyg){if(a(this).hasClass("on")){b.styleWithCSS(),b.iframe.contentWindow.document.execCommand("Unlink",!1,null),b.focusEditor();return}var c=a(b.iframe).getSelection();if(c==""){alert(b.settings.translation.selectTextToHyperlink),b.focusEditor();return}var d=prompt(b.settings.translation.linkURL,"http://");d!=null&&(b.styleWithCSS(),b.iframe.contentWindow.document.execCommand("CreateLink",!1,d),b.toolbar.setState("link","on"),b.focusEditor())}}},orderedlist:{className:"depageEditorButtonOrderedList",action:function(){var b=a.data(this,"editor");!b.wysiwyg||(b.styleWithCSS(),b.iframe.contentWindow.document.execCommand("insertorderedlist",!1,null),b.toolbar.setState("orderedlist","on"),b.focusEditor())}},unorderedlist:{className:"depageEditorButtonUnorderedList",action:function(){var b=a.data(this,"editor");!b.wysiwyg||(b.styleWithCSS(),b.iframe.contentWindow.document.execCommand("insertunorderedlist",!1,null),b.toolbar.setState("unorderedlist","on"),b.focusEditor())}},image:{className:"depageEditorButtonImage",action:function(){var b=a.data(this,"editor");if(!!b.wysiwyg){var c=prompt(b.settings.translation.imageLocation,"");if(c!=null&&c!=""){var d=prompt(b.settings.translation.imageAlternateText,"");d=d.replace(/"/g,"'"),a(b.iframe).appendToSelection("img",{src:c,alt:d},null,!0)}b.focusEditor()}}},htmlsource:{className:"depageEditorButtonHTML",action:function(){var b=a.data(this,"editor");b.switchMode()}},formatblock:{className:"depageEditorSelectformatblock",action:function(){var b=a.data(this,"editor");if(!!b.wysiwyg){var c=a.browser.msie?"<"+a(this).val()+">":a(this).val();b.styleWithCSS(),b.iframe.contentWindow.document.execCommand("FormatBlock",!1,c),b.focusEditor()}}}})};a.depageEditorToolbarItems=new d,a.fn.extend({getSelection:function(){if(!!this.is("iframe")){iframe=this[0];return iframe.contentWindow.document.selection?iframe.contentWindow.document.selection.createRange().text:iframe.contentWindow.getSelection().toString()}},appendToSelection:function(b,c,d,e){if(!!this.is("iframe")){iframe=this[0];var f,g;if(a.browser.msie){var h;h="<"+b,a.each(c,function(a,b){h+=" "+a+'="'+b+'"'}),e?h+=" />":(h+=">",d&&typeof d!="undefined"&&(h+=d),h+="</"+b+">"),f=iframe.contentWindow.document.selection,g=f.createRange();if(a(g.parentElement()).parents("body").is("#iframeBody "))return;g.collapse(!1),g.pasteHTML(h)}else{f=iframe.contentWindow.getSelection(),g=f.getRangeAt(0),g.collapse(!1);var i=iframe.contentWindow.document.createElement(b);a(i).attr(c),d&&typeof d!="undefined"&&a(i).append(document.createTextNode(d)),g.insertNode(i)}}},depageEditor:function(c){var d={bold:"Bold",italic:"Italic",link:"Hyperlink",unorderedlist:"Unordered List",orderedlist:"Ordered List",image:"Insert image",htmlsource:"HTML Source",formatblock:"Change Block Type",h1:"Heading 1",h2:"Heading 2",h3:"Heading 3",h4:"Heading 4",h5:"Heading 5",h6:"Heading 6",p:"Paragraph",selectTextToHyperlink:"Please select the text you wish to hyperlink.",linkURL:"Enter the URL for this link:",imageLocation:"Enter the location for this image:",imageAlternateText:"Enter the alternate text for this image:"},e={script:"remove",meta:"remove",link:"remove",basefont:"remove",object:"remove",applet:"remove",input:"remove",select:"remove",textarea:"remove",button:"remove",isindex:"remove",area:"remove",frame:"remove",frameset:"remove",noframes:"remove",iframe:"remove"},f=["p","h1","h2","ul","ol","li","a","b","strong","i","em"],g=["class","id","href","title","alt","src"];c=a.extend({insertParagraphs:!0,stylesheet:"depageEditorContent.css",toolbarItems:["bold","italic","link","orderedlist","unorderedlist","htmlsource","formatblock"],selectBlockOptions:["h1","h2","h3","h4","h5","h6","p"],undesiredTags:e,allowedTags:f,allowedClasses:[],allowedIDs:[],allowedAttributes:g,containerClass:"depageEditor",translation:d,autogrow:!1},c);for(var h=c.selectBlockOptions.length-1;h>=0;h--)a.inArray(c.selectBlockOptions[h],c.allowedTags)===-1&&c.selectBlockOptions.splice(h,1);c.undesiredTags=c.undesiredTags.length!=e.length?a.removeDuplicate(a.merge(c.undesiredTags,e)):c.undesiredTags,c.allowedAttributes=c.allowedAttributes.length!=g.length?a.removeDuplicate(a.merge(c.allowedAttributes,g)):c.allowedAttributes;return this.each(function(){new b(this,c)})}})})(jQuery)